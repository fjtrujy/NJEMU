name: Web ROM Converter

on:
  push:
  pull_request:
  workflow_dispatch: {}

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Build Web Interface
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 'latest'

    - name: Verify Emscripten
      run: emcc -v

    - name: Build romcnv WASM (experimental)
      run: |
        cd romcnv
        mkdir -p build_wasm
        cd build_wasm
        emcmake cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DTARGET=MVS \
          ..
        emmake make -j$(nproc)
        
    - name: Prepare web files
      run: |
        mkdir -p dist
        
        # Copy web interface files
        cp web/index.html dist/
        cp web/style.css dist/
        cp web/app.js dist/
        
        # Copy WASM files if they exist (binary is named romcnv_mvs)
        if [ -f romcnv/build_wasm/romcnv_mvs.js ]; then
          cp romcnv/build_wasm/romcnv_mvs.js dist/romcnv.js
        fi
        if [ -f romcnv/build_wasm/romcnv_mvs.wasm ]; then
          cp romcnv/build_wasm/romcnv_mvs.wasm dist/romcnv.wasm
        fi
        if [ -f romcnv/build_wasm/romcnv_mvs.data ]; then
          cp romcnv/build_wasm/romcnv_mvs.data dist/romcnv.data
        fi
        
        # Create placeholder if WASM build failed
        if [ ! -f dist/romcnv.wasm ]; then
          echo "console.log('WASM module not available - build in progress');" > dist/romcnv.js
        fi

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'dist'

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

